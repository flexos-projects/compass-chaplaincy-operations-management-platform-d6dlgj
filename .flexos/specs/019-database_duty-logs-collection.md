---
id: database-duty-logs-collection
title: "Duty Logs Collection"
description: "Complete schema, relationships, indexes, security rules, and data lifecycle for the duty_logs collection (chaplain shift records)"
type: spec
subtype: database
status: draft
sequence: 19
tags: [database, schema, duty-logs, shifts, payroll]
relatesTo: [docs/core/004-database.md, docs/core/007-technical.md, specs/015-pages_stipends.md]
createdAt: "2026-02-09T00:30:00Z"
updatedAt: "2026-02-09T00:30:00Z"
---

# Database: Duty Logs Collection

## Overview

The `duty_logs` collection tracks individual chaplain shift records — clock-in/clock-out events with location, hours worked, approval status, and payment linkage. This is the source of truth for stipend processing and duty hour analytics. Each document represents a single shift for a single chaplain.

## Collection Name

`duty_logs`

**Document ID:** Auto-generated by Firestore (no semantic meaning)

**Estimated document count:** 500-5000 per year (depends on chaplain count and shift frequency)

## Schema

```block flex_block
type: schema
format: typescript
name: DutyLog
---
interface DutyLog {
  // ========================================
  // CORE SHIFT DATA
  // ========================================
  userId: string                           // Reference to users.uid (chaplain who worked this shift)
  startTime: Timestamp                     // Shift start timestamp (clock-in)
  endTime?: Timestamp                      // Shift end timestamp (clock-out, null if still on duty)
  totalHours?: number                      // Total hours worked (calculated: endTime - startTime in hours)

  // ========================================
  // LOCATION
  // ========================================
  startLocation?: {                        // GPS coordinates at clock-in
    lat: number
    lng: number
  }
  endLocation?: {                          // GPS coordinates at clock-out
    lat: number
    lng: number
  }

  // ========================================
  // CALENDAR & SCHEDULING
  // ========================================
  dayName?: string                         // Day of the week ("Monday", "Tuesday", etc.)
  week?: number                            // ISO week number (1-53)
  year?: number                            // Year of the shift (e.g., 2026)
  hours?: number[]                         // Hour slots covered (e.g., [5, 6, 7] for 5-7 AM), used for coverage grid mapping

  // ========================================
  // APPROVAL & PAYMENT STATUS
  // ========================================
  approved: boolean                        // Admin-approved shift (default: true in v1, future: manual approval workflow)
  isPaid: boolean                          // Payment processed flag (default: false)
  paymentAmount?: number                   // Dollar amount paid for this shift (base rate + adjustments)
  paymentStatus?: 'pending' | 'approved' | 'paid'  // Payment workflow status (future use)
  adjustmentAmount?: number                // Positive or negative adjustment applied by admin (dollars)
  hasAdjustment: boolean                   // Whether any adjustment was applied (for quick filtering)
  checkNumber?: string                     // Check number used for payment (from payout processing)
  payoutId?: string                        // Reference to chaplain_payouts document ID (links shift to payout record)
  processedBy?: string                     // UID of admin who processed the payment (for audit)
  processedAt?: Timestamp                  // When payment was processed (for audit)
}
```

## Field Descriptions

### Core Shift Data

- **userId:** UID of the chaplain who worked this shift. References `users.uid`. Required for all duty logs.
- **startTime:** Clock-in timestamp. Set when chaplain starts shift via mobile app. Required field.
- **endTime:** Clock-out timestamp. Set when chaplain ends shift. Null while shift is active (on duty).
- **totalHours:** Calculated duration in hours. Formula: `(endTime - startTime) / 3600000` (milliseconds to hours). Set when shift ends.

### Location Fields

- **startLocation:** GPS coordinates captured at clock-in. Used for attendance verification and location-based analytics (future: geo-fencing).
- **endLocation:** GPS coordinates captured at clock-out. Can identify if chaplain ended shift at a different terminal.

### Calendar & Scheduling Fields

- **dayName:** Human-readable day name (e.g., "Monday"). Derived from `startTime`. Used for coverage grid display and weekly reports.
- **week:** ISO week number (1-53). Derived from `startTime`. Used for weekly grouping and coverage schedule mapping.
- **year:** Year of the shift. Derived from `startTime`. Used for annual reporting and YTD calculations.
- **hours:** Array of hour slots covered by this shift. Example: A shift from 8:00 AM to 2:00 PM would be `[8, 9, 10, 11, 12, 13]`. This maps to the coverage grid (5 AM = 5, 9 PM = 21). Calculated when shift ends.

### Approval & Payment Fields

- **approved:** Admin approval flag. Default: `true` in v1 (automatic approval). Future: manual approval workflow where admins review shifts before they qualify for payment.
- **isPaid:** Whether this shift has been paid via stipend processing. Default: `false`. Set to `true` when included in a payout batch.
- **paymentAmount:** Dollar amount paid for this shift. Formula: `baseStipendRate + adjustmentAmount`. Set during stipend processing.
- **paymentStatus:** Workflow status for payment tracking. Values: `pending` (shift complete, awaiting payment), `approved` (admin reviewed), `paid` (processed). Future feature, not actively used in v1.
- **adjustmentAmount:** Dollar adjustment applied by admin during stipend processing. Can be positive (bonus, holiday pay) or negative (partial shift, deduction). Example: +$20 for a holiday shift.
- **hasAdjustment:** Boolean flag for quick filtering of adjusted shifts. Set to `true` if `adjustmentAmount !== 0`.
- **checkNumber:** Check number from the payout batch this shift was included in. Example: "CHK-2026-0147". Set during stipend processing.
- **payoutId:** Document ID of the `chaplain_payouts` record that includes this shift. Allows tracing from shift to payout and vice versa.
- **processedBy:** UID of the admin who processed the payout. For audit trail.
- **processedAt:** Server timestamp when payment was processed. For audit trail.

## Relationships

### Outbound References (duty_logs → other collections)

| Field | References | Collection | Cardinality |
|-------|-----------|-----------|-------------|
| userId | users.uid | users | Many-to-One (many shifts belong to one chaplain) |
| payoutId | chaplain_payouts.[id] | chaplain_payouts | Many-to-One (many shifts in one payout) |
| processedBy | users.uid | users | Many-to-One (many shifts processed by one admin) |

### Inbound References (other collections → duty_logs)

| Collection | Field | Relationship |
|-----------|-------|-------------|
| chaplain_payouts | dutyLogIds[] | Payout record lists all included duty log IDs (Many-to-Many via array) |

## Indexes

**Required composite indexes for `duty_logs` collection:**

```
// User + startTime (for per-chaplain duty history)
duty_logs: userId ASC, startTime DESC

// isPaid + startTime (for unpaid shift queries, stipend processing)
duty_logs: isPaid ASC, startTime ASC
duty_logs: isPaid ASC, startTime DESC

// Year + Week + User (for weekly grouping and coverage analysis)
duty_logs: year ASC, week ASC, userId ASC

// StartTime descending (for recent shifts on dashboard)
duty_logs: startTime DESC

// isPaid + year + week (for monthly stipend queries with period filtering)
duty_logs: isPaid ASC, year ASC, week ASC
```

**Index creation:**

```bash
firebase deploy --only firestore:indexes
```

## Security Rules

```javascript
// duty_logs: Admins can read/write. Chaplains can create their own logs (clock-in/out).
match /duty_logs/{logId} {
  // Allow any authenticated user to read duty logs (for transparency, peer accountability)
  allow read: if request.auth != null;

  // Allow chaplains to create their own duty logs (mobile app clock-in)
  allow create: if request.auth != null
    && request.resource.data.userId == request.auth.uid
    && request.resource.data.isPaid == false  // Can't create pre-paid logs
    && request.resource.data.approved == true;  // Default approval

  // Allow chaplains to update their own ACTIVE duty logs (clock-out)
  allow update: if request.auth != null
    && resource.data.userId == request.auth.uid
    && resource.data.isPaid == false  // Can't edit paid logs
    && onlyUpdatingAllowedFields(['endTime', 'endLocation', 'totalHours', 'dayName', 'week', 'year', 'hours']);

  // Allow admins to update or delete any duty log
  allow update, delete: if isAdmin();
}

// Helper: Check if only allowed fields are being updated
function onlyUpdatingAllowedFields(allowedFields) {
  let affectedKeys = request.resource.data.diff(resource.data).affectedKeys();
  return affectedKeys.hasOnly(allowedFields);
}

// Helper: Check admin status
function isAdmin() {
  return request.auth != null
    && get(/databases/$(database)/documents/app_settings/config).data.adminUserIds.hasAny([request.auth.uid]);
}
```

**Key rules:**
1. **Read:** Any authenticated user can read duty logs (transparency for chaplains to see peer activity, admins for reporting).
2. **Create:** Chaplains can create duty logs for themselves (mobile app clock-in). Must set `userId` to their own UID, `isPaid` to false, `approved` to true.
3. **Update (chaplain):** Chaplains can update their own active (unpaid) logs to set clock-out fields. Once paid, logs become immutable for chaplains.
4. **Update/Delete (admin):** Admins have full write access for corrections and stipend processing.

## Data Lifecycle

### Creation (Clock-In)

**Trigger:** Chaplain clicks "Clock In" in mobile app

**Process:**
1. Mobile app captures current GPS coordinates
2. Create duty_logs document:
   ```typescript
   {
     userId: currentUser.uid,
     startTime: serverTimestamp(),
     startLocation: { lat, lng },
     approved: true,
     isPaid: false,
     hasAdjustment: false
   }
   ```
3. Update `users.onDuty = true` for the chaplain

### Update (Clock-Out)

**Trigger:** Chaplain clicks "Clock Out" in mobile app

**Process:**
1. Mobile app captures current GPS coordinates
2. Calculate shift duration and calendar fields
3. Update duty_logs document:
   ```typescript
   {
     endTime: serverTimestamp(),
     endLocation: { lat, lng },
     totalHours: (endTime - startTime) / 3600000,
     dayName: getDayName(startTime),
     week: getISOWeek(startTime),
     year: getYear(startTime),
     hours: getHourSlots(startTime, endTime)  // e.g., [8, 9, 10, 11, 12]
   }
   ```
4. Update `users.onDuty = false` for the chaplain
5. Update `users.totalTime += totalHours` (denormalized total)

### Payment Processing

**Trigger:** Admin processes stipend batch on `/stipends` page

**Process:** (via server API route `/api/stipends/process`)
1. Admin selects duty logs for payment (filtered by month, unpaid status)
2. Admin applies optional adjustments to individual shifts
3. Admin enters check number and confirms
4. Server batch updates selected duty logs:
   ```typescript
   {
     isPaid: true,
     paymentAmount: baseStipendRate + (adjustmentAmount || 0),
     paymentStatus: 'paid',
     adjustmentAmount: adjustmentAmount || 0,
     hasAdjustment: adjustmentAmount !== 0,
     checkNumber: checkNumber,
     payoutId: newPayoutDocId,
     processedBy: adminUid,
     processedAt: serverTimestamp()
   }
   ```
5. Create corresponding `chaplain_payouts` document
6. Create/update `stipend_records` document
7. Create `audit_log` entry

### Deletion

**Use case:** Accidental clock-in, duplicate entries, data cleanup

**Process:**
- Admin deletes duty_logs document via dashboard (future feature)
- If log is already paid: warn admin, require confirmation, create audit_log entry
- If log is unpaid: allow deletion, update `users.totalTime` to subtract hours

## Common Queries

### Unpaid shifts for stipend processing

```typescript
query(collection('duty_logs'),
  where('isPaid', '==', false),
  where('startTime', '>=', periodStart),
  where('startTime', '<=', periodEnd),
  orderBy('startTime', 'asc')
)
```

### Per-chaplain duty history

```typescript
query(collection('duty_logs'),
  where('userId', '==', chaplainId),
  orderBy('startTime', 'desc'),
  limit(20)
)
```

### Recent shifts for dashboard

```typescript
query(collection('duty_logs'),
  orderBy('startTime', 'desc'),
  limit(10)
)
```

### Active shifts (currently on duty)

```typescript
query(collection('duty_logs'),
  where('endTime', '==', null),
  orderBy('startTime', 'desc')
)
```

## Data Quality Considerations

### Hour Slots Calculation

- **hours array:** Must accurately map shift duration to hourly slots.
- **Edge case:** Shift spanning midnight (e.g., 11 PM to 2 AM) should split into two days' slots or handle as a continuous range.
- **Coverage grid mapping:** Slots must align with coverage grid hours (5 AM = 5, 9 PM = 21).

### Timezone Handling

- **All timestamps use server timezone** (assumed: local airport timezone, e.g., US Central for DFW).
- **Risk:** If chaplain's device is in a different timezone, clock-in/out times could be incorrect.
- **Mitigation:** Mobile app should force server timezone for duty log timestamps.

### Payment Immutability

- **Once `isPaid = true`, duty logs should not be edited** (except by admins for corrections).
- **Audit trail:** Any admin edit to a paid log should create an audit_log entry with before/after values.

## Open Questions

1. **Approval workflow:** Should admins manually approve shifts before they qualify for payment, or trust auto-approval?
2. **Shift duration validation:** Should there be a max shift length (e.g., reject shifts >12 hours without manual review)?
3. **Location accuracy:** How to handle GPS inaccuracies (e.g., chaplain clocks in at Terminal A but GPS shows Terminal B)?
4. **Break time:** Should shifts support break periods (unpaid time within a shift), or rely on multiple clock-in/out cycles?

## Related Documents

- Core Database Doc: `docs/core/004-database.md` (Relationship diagram, collection inventory)
- Core Flows Doc: `docs/core/005-flows.md` (FL-010 Monthly Stipend Processing)
- Pages Spec: `specs/015-pages_stipends.md` (Stipend processing workflow)
- Users Collection Spec: `specs/018-database_users-collection.md` (userId reference, totalTime denormalization)

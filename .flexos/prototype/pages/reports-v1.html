<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Reports - COMPASS</title>

  <!-- CDN Stack -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@unocss/reset/tailwind.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@unocss/runtime"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <link rel="stylesheet" href="../shared/tokens.css">
  <link rel="stylesheet" href="../shared/components.css">
  <script src="../shared/mock-data.js"></script>

  <style>
    .bar-chart-row {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) 0;
    }
    .bar-chart-label {
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      min-width: 80px;
      color: var(--color-foreground);
    }
    .bar-chart-track {
      flex: 1;
      height: 28px;
      background: var(--color-gray-100);
      border-radius: var(--radius-md);
      overflow: hidden;
      position: relative;
    }
    .bar-chart-fill {
      height: 100%;
      border-radius: var(--radius-md);
      transition: width var(--transition-slow);
      display: flex;
      align-items: center;
      padding-left: var(--space-2);
      font-size: var(--text-xs);
      font-weight: var(--font-semibold);
      color: #FFFFFF;
      min-width: fit-content;
    }
    .bar-chart-value {
      font-size: var(--text-sm);
      font-weight: var(--font-semibold);
      min-width: 48px;
      text-align: right;
      color: var(--color-foreground);
    }
    .metric-card {
      background: var(--color-surface-elevated);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    .metric-card-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .metric-card-value {
      font-size: var(--text-2xl);
      font-weight: var(--font-bold);
      color: var(--color-foreground);
    }
    .metric-card-label {
      font-size: var(--text-xs);
      color: var(--color-muted);
      font-weight: var(--font-medium);
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }
    .section-title {
      font-size: var(--text-lg);
      font-weight: var(--font-semibold);
      color: var(--color-foreground);
    }
    .toast {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      background: var(--color-primary-900);
      color: #FFFFFF;
      padding: var(--space-3) var(--space-5);
      border-radius: var(--radius-lg);
      font-size: var(--text-sm);
      font-weight: var(--font-medium);
      box-shadow: var(--shadow-xl);
      z-index: var(--z-tooltip);
      animation: slideUp var(--transition-slow) ease both;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) var(--space-3);
      background: var(--color-surface);
      border-radius: var(--radius-md);
      font-size: var(--text-sm);
    }
    .summary-row:nth-child(even) { background: var(--color-gray-50); }
    .summary-row-label { color: var(--color-muted); }
    .summary-row-value { font-weight: var(--font-semibold); }
  </style>
</head>
<body>

<div id="app">

  <!-- ============================================
       DESKTOP LAYOUT (>= 768px)
       ============================================ -->
  <div v-if="!isMobile" class="app-shell-desktop fade-in">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-logo">
        <i data-lucide="compass" style="color: #39D2C0;"></i>
        <span>COMPASS</span>
      </div>

      <nav class="sidebar-nav">
        <a href="dashboard-v1.html" class="sidebar-link">
          <i data-lucide="layout-dashboard"></i>
          <span>Dashboard</span>
        </a>
        <a href="users-v1.html" class="sidebar-link">
          <i data-lucide="users"></i>
          <span>Users</span>
        </a>
        <a href="duty-days-v1.html" class="sidebar-link">
          <i data-lucide="clock"></i>
          <span>Duty Days</span>
        </a>
        <a href="coverage-v1.html" class="sidebar-link">
          <i data-lucide="calendar-check"></i>
          <span>Coverage</span>
        </a>
        <a href="stipends-v1.html" class="sidebar-link">
          <i data-lucide="dollar-sign"></i>
          <span>Stipends</span>
        </a>
        <a href="reports-v1.html" class="sidebar-link active">
          <i data-lucide="bar-chart-3"></i>
          <span>Reports</span>
        </a>

        <div class="sidebar-section-label">System</div>
        <a href="settings-v1.html" class="sidebar-link">
          <i data-lucide="settings"></i>
          <span>Settings</span>
        </a>
      </nav>

      <div class="sidebar-user">
        <div class="avatar avatar-md">
          <img src="https://i.pravatar.cc/150?img=5" alt="Admin">
        </div>
        <div style="flex: 1;">
          <div class="sidebar-user-name">Linda Martinez</div>
          <div class="sidebar-user-role">Administrator</div>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <div class="main-content">
      <header class="topbar">
        <h1 class="topbar-title">Reports & Analytics</h1>
        <div class="topbar-actions">
          <span style="font-size: var(--text-sm); color: var(--color-muted);">{{ currentDate }}</span>
        </div>
      </header>

      <main class="content-scroll">

        <!-- Filter Bar -->
        <div class="card" style="margin-bottom: var(--space-6);">
          <div style="display: flex; align-items: center; gap: var(--space-4); flex-wrap: wrap;">
            <div style="display: flex; align-items: center; gap: var(--space-2);">
              <span style="font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-muted);">Period:</span>
              <div class="chip-group">
                <button v-for="range in dateRanges" :key="range.value"
                        class="chip" :class="{ active: selectedRange === range.value }"
                        @click="selectedRange = range.value">
                  {{ range.label }}
                </button>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: var(--space-2);">
              <span style="font-size: var(--text-sm); font-weight: var(--font-medium); color: var(--color-muted);">Terminal:</span>
              <select class="input" style="width: auto; min-width: 120px; min-height: 36px; font-size: var(--text-sm);" v-model="selectedTerminal">
                <option value="all">All Terminals</option>
                <option v-for="t in terminals" :key="t" :value="t">Terminal {{ t }}</option>
              </select>
            </div>
          </div>
        </div>


        <!-- === SECTION 1: Encounter Metrics === -->
        <div style="margin-bottom: var(--space-8);">
          <div class="section-header">
            <h2 class="section-title">
              <i data-lucide="activity" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: var(--space-2);"></i>
              Encounter Metrics
            </h2>
            <button class="btn btn-secondary btn-sm" @click="exportCSV('encounters')">
              <i data-lucide="download" style="width: 14px; height: 14px;"></i>
              Export CSV
            </button>
          </div>

          <!-- Encounter Summary Cards -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-4); margin-bottom: var(--space-6);" class="stagger-in">
            <div class="metric-card card-hover">
              <div class="metric-card-icon" style="background: var(--color-primary-100);">
                <i data-lucide="message-circle" style="width: 20px; height: 20px; color: var(--color-primary);"></i>
              </div>
              <div>
                <div class="metric-card-value">{{ encounterCounts.total }}</div>
                <div class="metric-card-label">Total Encounters</div>
              </div>
            </div>
            <div class="metric-card card-hover">
              <div class="metric-card-icon" style="background: var(--color-error-100);">
                <i data-lucide="alert-circle" style="width: 20px; height: 20px; color: var(--color-error);"></i>
              </div>
              <div>
                <div class="metric-card-value">{{ encounterCounts.crisis }}</div>
                <div class="metric-card-label">Crisis Events</div>
              </div>
            </div>
            <div class="metric-card card-hover">
              <div class="metric-card-icon" style="background: var(--color-accent-100);">
                <i data-lucide="heart" style="width: 20px; height: 20px; color: var(--color-accent-600);"></i>
              </div>
              <div>
                <div class="metric-card-value">{{ encounterCounts.prayer }}</div>
                <div class="metric-card-label">Prayer Requests</div>
              </div>
            </div>
            <div class="metric-card card-hover">
              <div class="metric-card-icon" style="background: var(--color-warning-100);">
                <i data-lucide="cloud-rain" style="width: 20px; height: 20px; color: var(--color-warning-700);"></i>
              </div>
              <div>
                <div class="metric-card-value">{{ encounterCounts.grief }}</div>
                <div class="metric-card-label">Grief Counseling</div>
              </div>
            </div>
          </div>

          <!-- Encounter Type Bar Chart -->
          <div class="card" style="margin-bottom: var(--space-4);">
            <div class="card-header">
              <h3 class="card-title" style="font-size: var(--text-base);">Encounter Type Distribution</h3>
            </div>
            <div v-if="filteredMetrics.length === 0" class="empty-state" style="padding: var(--space-8) var(--space-4);">
              <i data-lucide="bar-chart-3"></i>
              <p>No encounters found for the selected filters</p>
            </div>
            <div v-else>
              <div v-for="item in encounterTypeChart" :key="item.label" class="bar-chart-row">
                <div class="bar-chart-label">{{ item.label }}</div>
                <div class="bar-chart-track">
                  <div class="bar-chart-fill" :style="{ width: Math.max(item.pct, 2) + '%', background: item.color }">
                    {{ item.count > 0 ? item.count : '' }}
                  </div>
                </div>
                <div class="bar-chart-value">{{ item.pct }}%</div>
              </div>
            </div>
          </div>

          <!-- Recent Encounters Table -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title" style="font-size: var(--text-base);">Recent Encounters</h3>
              <p class="card-subtitle">{{ filteredMetrics.length }} records in period</p>
            </div>
            <div v-if="filteredMetrics.length === 0" style="padding: var(--space-4); text-align: center; color: var(--color-muted); font-size: var(--text-sm);">
              No encounters match the current filters.
            </div>
            <div v-else class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Chaplain</th>
                    <th>Terminal</th>
                    <th>Type</th>
                    <th>Duration</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="m in filteredMetrics.slice(0, 10)" :key="m.id">
                    <td>{{ formatDate(m.dateCollected) }}</td>
                    <td>
                      <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <div class="avatar avatar-sm">
                          <span>{{ getUserName(m.chaplainId).charAt(0) }}</span>
                        </div>
                        <span style="font-weight: var(--font-medium);">{{ getUserName(m.chaplainId) }}</span>
                      </div>
                    </td>
                    <td>{{ m.terminal || '---' }}</td>
                    <td>
                      <div style="display: flex; flex-wrap: wrap; gap: var(--space-1);">
                        <span v-if="m.encounterType?.crisis" class="badge badge-error">Crisis</span>
                        <span v-if="m.encounterType?.grief" class="badge badge-warning">Grief</span>
                        <span v-if="m.encounterType?.prayerRequested" class="badge badge-accent">Prayer</span>
                        <span v-if="m.encounterType?.travelRelated" class="badge badge-primary">Travel</span>
                        <span v-if="m.encounterType?.personalIssue" class="badge badge-gray">Personal</span>
                        <span v-if="m.encounterType?.policeInvolved" class="badge badge-error">Police</span>
                      </div>
                    </td>
                    <td>{{ m.durationMinutes || 0 }} min</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>


        <!-- === SECTION 2: Duty Hours Summary === -->
        <div style="margin-bottom: var(--space-8);">
          <div class="section-header">
            <h2 class="section-title">
              <i data-lucide="clock" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: var(--space-2);"></i>
              Duty Hours Summary
            </h2>
            <button class="btn btn-secondary btn-sm" @click="exportCSV('duty')">
              <i data-lucide="download" style="width: 14px; height: 14px;"></i>
              Export CSV
            </button>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title" style="font-size: var(--text-base);">Hours by Chaplain</h3>
            </div>
            <div v-if="dutyHoursSummary.length === 0" style="padding: var(--space-4); text-align: center; color: var(--color-muted); font-size: var(--text-sm);">
              No duty logs match the current filters.
            </div>
            <div v-else class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th>Chaplain</th>
                    <th style="text-align: right;">Total Hours</th>
                    <th style="text-align: right;">Avg Hours/Week</th>
                    <th>Most Common Terminal</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="row in dutyHoursSummary" :key="row.userId">
                    <td>
                      <div style="display: flex; align-items: center; gap: var(--space-2);">
                        <div class="avatar avatar-sm">
                          <span>{{ row.name.charAt(0) }}</span>
                        </div>
                        <span style="font-weight: var(--font-medium);">{{ row.name }}</span>
                      </div>
                    </td>
                    <td style="text-align: right; font-variant-numeric: tabular-nums;">{{ row.totalHours.toFixed(1) }}</td>
                    <td style="text-align: right; font-variant-numeric: tabular-nums;">{{ row.avgPerWeek.toFixed(1) }}</td>
                    <td>{{ row.topTerminal || '---' }}</td>
                  </tr>
                  <tr style="background: var(--color-gray-50); font-weight: var(--font-semibold);">
                    <td>Totals</td>
                    <td style="text-align: right; font-variant-numeric: tabular-nums;">{{ dutyGrandTotal.toFixed(1) }}</td>
                    <td style="text-align: right;">---</td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>


        <!-- === SECTION 3: Stipend Summary === -->
        <div style="margin-bottom: var(--space-8);">
          <div class="section-header">
            <h2 class="section-title">
              <i data-lucide="dollar-sign" style="width: 20px; height: 20px; display: inline-block; vertical-align: middle; margin-right: var(--space-2);"></i>
              Stipend Summary
            </h2>
            <button class="btn btn-secondary btn-sm" @click="exportCSV('stipends')">
              <i data-lucide="download" style="width: 14px; height: 14px;"></i>
              Export CSV
            </button>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title" style="font-size: var(--text-base);">Stipend Records</h3>
            </div>
            <div v-if="filteredStipends.length === 0" style="padding: var(--space-4); text-align: center; color: var(--color-muted); font-size: var(--text-sm);">
              No stipend records match the current filters.
            </div>
            <div v-else class="table-wrapper">
              <table class="table">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th style="text-align: right;">Chaplains Paid</th>
                    <th style="text-align: right;">Total Hours</th>
                    <th style="text-align: right;">Total Amount</th>
                    <th style="text-align: right;">Avg/Chaplain</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="row in stipendSummary" :key="row.month">
                    <td style="font-weight: var(--font-medium);">{{ row.month }} {{ row.year }}</td>
                    <td style="text-align: right; font-variant-numeric: tabular-nums;">{{ row.chaplainCount }}</td>
                    <td style="text-align: right; font-variant-numeric: tabular-nums;">{{ row.totalInstances }}</td>
                    <td style="text-align: right; font-variant-numeric: tabular-nums; font-weight: var(--font-semibold);">${{ row.totalAmount.toFixed(0) }}</td>
                    <td style="text-align: right; font-variant-numeric: tabular-nums;">${{ row.avgPerChaplain.toFixed(0) }}</td>
                  </tr>
                  <tr style="background: var(--color-gray-50); font-weight: var(--font-semibold);">
                    <td>YTD Totals</td>
                    <td style="text-align: right;">{{ stipendYTD.chaplains }}</td>
                    <td style="text-align: right;">{{ stipendYTD.instances }}</td>
                    <td style="text-align: right;">${{ stipendYTD.amount.toFixed(0) }}</td>
                    <td style="text-align: right;">${{ stipendYTD.avg.toFixed(0) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>


  <!-- ============================================
       MOBILE LAYOUT (< 768px)
       ============================================ -->
  <div v-if="isMobile" class="app-shell-mobile fade-in">

    <!-- Mobile Header -->
    <header class="mobile-header">
      <h1 class="mobile-header-title">Reports</h1>
      <button class="btn btn-ghost btn-icon btn-sm">
        <i data-lucide="bell" style="width: 20px; height: 20px;"></i>
      </button>
    </header>

    <!-- Mobile Content -->
    <main class="mobile-content">

      <!-- Filter Chips (Mobile) -->
      <div style="display: flex; gap: var(--space-2); overflow-x: auto; margin-bottom: var(--space-4); padding-bottom: var(--space-1);">
        <button v-for="range in dateRanges" :key="range.value"
                class="chip pressable" :class="{ active: selectedRange === range.value }"
                @click="selectedRange = range.value"
                style="white-space: nowrap;">
          {{ range.label }}
        </button>
      </div>

      <!-- Terminal Filter (Mobile) -->
      <div style="margin-bottom: var(--space-4);">
        <select class="input" style="font-size: var(--text-sm);" v-model="selectedTerminal">
          <option value="all">All Terminals</option>
          <option v-for="t in terminals" :key="t" :value="t">Terminal {{ t }}</option>
        </select>
      </div>

      <!-- Encounter Cards (Mobile) -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-3); margin-bottom: var(--space-6);" class="stagger-in">
        <div class="kpi-card pressable">
          <div class="kpi-label">Encounters</div>
          <div class="kpi-value" style="font-size: var(--text-2xl);">{{ encounterCounts.total }}</div>
        </div>
        <div class="kpi-card pressable">
          <div class="kpi-label">Crisis</div>
          <div class="kpi-value" style="font-size: var(--text-2xl); color: var(--color-error);">{{ encounterCounts.crisis }}</div>
        </div>
        <div class="kpi-card pressable">
          <div class="kpi-label">Prayer</div>
          <div class="kpi-value" style="font-size: var(--text-2xl); color: var(--color-accent-600);">{{ encounterCounts.prayer }}</div>
        </div>
        <div class="kpi-card pressable">
          <div class="kpi-label">Grief</div>
          <div class="kpi-value" style="font-size: var(--text-2xl); color: var(--color-warning-700);">{{ encounterCounts.grief }}</div>
        </div>
      </div>

      <!-- Encounter Type Chart (Mobile) -->
      <div class="card" style="margin-bottom: var(--space-6);">
        <div class="card-header">
          <h2 class="card-title">Encounter Types</h2>
        </div>
        <div v-if="filteredMetrics.length === 0" style="padding: var(--space-4); text-align: center; color: var(--color-muted); font-size: var(--text-sm);">
          No encounters found
        </div>
        <div v-else>
          <div v-for="item in encounterTypeChart" :key="item.label" style="margin-bottom: var(--space-2);">
            <div style="display: flex; justify-content: space-between; font-size: var(--text-xs); margin-bottom: var(--space-1);">
              <span style="font-weight: var(--font-medium);">{{ item.label }}</span>
              <span style="color: var(--color-muted);">{{ item.count }} ({{ item.pct }}%)</span>
            </div>
            <div class="bar-chart-track" style="height: 20px;">
              <div class="bar-chart-fill" :style="{ width: Math.max(item.pct, 3) + '%', background: item.color }"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Duty Hours (Mobile) -->
      <div class="card" style="margin-bottom: var(--space-6);">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h2 class="card-title">Duty Hours</h2>
          <button class="btn btn-secondary btn-sm" @click="exportCSV('duty')">
            <i data-lucide="download" style="width: 14px; height: 14px;"></i>
            CSV
          </button>
        </div>
        <div v-if="dutyHoursSummary.length === 0" style="padding: var(--space-4); text-align: center; color: var(--color-muted); font-size: var(--text-sm);">
          No duty logs found
        </div>
        <div v-else style="display: flex; flex-direction: column; gap: var(--space-2);">
          <div v-for="row in dutyHoursSummary" :key="row.userId"
               class="pressable"
               style="padding: var(--space-3); border-radius: var(--radius-md); border: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: var(--font-medium); font-size: var(--text-sm);">{{ row.name }}</div>
              <div style="font-size: var(--text-xs); color: var(--color-muted);">{{ row.topTerminal || 'No terminal' }}</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: var(--font-bold); font-size: var(--text-sm);">{{ row.totalHours.toFixed(1) }}h</div>
              <div style="font-size: var(--text-xs); color: var(--color-muted);">{{ row.avgPerWeek.toFixed(1) }}h/wk</div>
            </div>
          </div>
          <div style="padding: var(--space-3); border-radius: var(--radius-md); background: var(--color-gray-50); display: flex; justify-content: space-between; font-weight: var(--font-semibold); font-size: var(--text-sm);">
            <span>Grand Total</span>
            <span>{{ dutyGrandTotal.toFixed(1) }}h</span>
          </div>
        </div>
      </div>

      <!-- Stipend Summary (Mobile) -->
      <div class="card" style="margin-bottom: var(--space-6);">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
          <h2 class="card-title">Stipends</h2>
          <button class="btn btn-secondary btn-sm" @click="exportCSV('stipends')">
            <i data-lucide="download" style="width: 14px; height: 14px;"></i>
            CSV
          </button>
        </div>
        <div v-if="filteredStipends.length === 0" style="padding: var(--space-4); text-align: center; color: var(--color-muted); font-size: var(--text-sm);">
          No stipend records found
        </div>
        <div v-else style="display: flex; flex-direction: column; gap: var(--space-2);">
          <div v-for="row in stipendSummary" :key="row.month"
               class="pressable"
               style="padding: var(--space-3); border-radius: var(--radius-md); border: 1px solid var(--color-border); display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: var(--font-medium); font-size: var(--text-sm);">{{ row.month }} {{ row.year }}</div>
              <div style="font-size: var(--text-xs); color: var(--color-muted);">{{ row.chaplainCount }} chaplains</div>
            </div>
            <div style="text-align: right;">
              <div style="font-weight: var(--font-bold); font-size: var(--text-sm);">${{ row.totalAmount.toFixed(0) }}</div>
              <div style="font-size: var(--text-xs); color: var(--color-muted);">${{ row.avgPerChaplain.toFixed(0) }}/ea</div>
            </div>
          </div>
          <div style="padding: var(--space-3); border-radius: var(--radius-md); background: var(--color-gray-50); display: flex; justify-content: space-between; font-weight: var(--font-semibold); font-size: var(--text-sm);">
            <span>YTD Total</span>
            <span>${{ stipendYTD.amount.toFixed(0) }}</span>
          </div>
        </div>
      </div>

    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
      <a href="dashboard-v1.html" class="bottom-nav-item" style="text-decoration: none;">
        <i data-lucide="layout-dashboard"></i>
        <span>Dashboard</span>
      </a>
      <a href="users-v1.html" class="bottom-nav-item" style="text-decoration: none;">
        <i data-lucide="users"></i>
        <span>Users</span>
      </a>
      <a href="duty-days-v1.html" class="bottom-nav-item" style="text-decoration: none;">
        <i data-lucide="clock"></i>
        <span>Duty</span>
      </a>
      <a href="stipends-v1.html" class="bottom-nav-item" style="text-decoration: none;">
        <i data-lucide="dollar-sign"></i>
        <span>Stipends</span>
      </a>
      <button class="bottom-nav-item active">
        <i data-lucide="bar-chart-3"></i>
        <span>Reports</span>
      </button>
    </nav>

  </div>


  <!-- Toast Notification -->
  <div v-if="toastVisible" class="toast">
    <i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>
    {{ toastMessage }}
  </div>

</div>

<script>
const { createApp, ref, computed, onMounted, onUnmounted, nextTick } = Vue;

createApp({
  setup() {
    const isMobile = ref(window.innerWidth < 768);
    const onResize = () => { isMobile.value = window.innerWidth < 768; };

    // Data
    const users = ref([]);
    const metrics = ref([]);
    const dutyLogs = ref([]);
    const stipendRecords = ref([]);

    // Filters
    const selectedRange = ref('90d');
    const selectedTerminal = ref('all');
    const terminals = ['A', 'B', 'C', 'D', 'E'];

    const dateRanges = [
      { label: 'Last 7 Days', value: '7d' },
      { label: 'Last 30 Days', value: '30d' },
      { label: 'Last 90 Days', value: '90d' },
      { label: 'Custom', value: 'all' }
    ];

    // Toast
    const toastVisible = ref(false);
    const toastMessage = ref('');

    function showToast(msg) {
      toastMessage.value = msg;
      toastVisible.value = true;
      setTimeout(() => { toastVisible.value = false; }, 3000);
      nextTick(() => lucide.createIcons());
    }

    // Current date display
    const currentDate = computed(() => {
      return new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    });

    // Date range calculation
    function getStartDate() {
      const now = new Date();
      switch (selectedRange.value) {
        case '7d': return new Date(now - 7 * 24 * 60 * 60 * 1000);
        case '30d': return new Date(now - 30 * 24 * 60 * 60 * 1000);
        case '90d': return new Date(now - 90 * 24 * 60 * 60 * 1000);
        default: return new Date('2020-01-01');
      }
    }

    // Filtered metrics
    const filteredMetrics = computed(() => {
      const startDate = getStartDate();
      return metrics.value
        .filter(m => {
          const d = new Date(m.dateCollected);
          if (d < startDate) return false;
          if (selectedTerminal.value !== 'all' && m.terminal !== selectedTerminal.value) return false;
          return true;
        })
        .sort((a, b) => new Date(b.dateCollected) - new Date(a.dateCollected));
    });

    // Filtered duty logs
    const filteredDutyLogs = computed(() => {
      const startDate = getStartDate();
      return dutyLogs.value.filter(l => {
        const d = new Date(l.startTime);
        return d >= startDate;
      });
    });

    // Filtered stipends
    const filteredStipends = computed(() => {
      const startDate = getStartDate();
      return stipendRecords.value.filter(s => {
        const d = new Date(s.startDate);
        return d >= startDate;
      });
    });

    // Encounter counts
    const encounterCounts = computed(() => {
      const data = filteredMetrics.value;
      return {
        total: data.length,
        crisis: data.filter(m => m.encounterType?.crisis).length,
        grief: data.filter(m => m.encounterType?.grief).length,
        prayer: data.filter(m => m.encounterType?.prayerRequested).length,
        travel: data.filter(m => m.encounterType?.travelRelated).length,
        personal: data.filter(m => m.encounterType?.personalIssue).length,
        police: data.filter(m => m.encounterType?.policeInvolved).length,
        violence: data.filter(m => m.encounterType?.violence).length
      };
    });

    // Encounter type chart data
    const encounterTypeChart = computed(() => {
      const c = encounterCounts.value;
      const total = c.total || 1;
      const types = [
        { label: 'Crisis', count: c.crisis, color: 'var(--color-error)' },
        { label: 'Grief', count: c.grief, color: 'var(--color-warning-600)' },
        { label: 'Prayer', count: c.prayer, color: 'var(--color-accent-500)' },
        { label: 'Travel', count: c.travel, color: 'var(--color-primary-400)' },
        { label: 'Personal', count: c.personal, color: 'var(--color-gray-500)' },
        { label: 'Police', count: c.police, color: 'var(--color-error-700)' },
        { label: 'Violence', count: c.violence, color: 'var(--color-error-400)' }
      ];
      return types
        .map(t => ({ ...t, pct: Math.round((t.count / total) * 100) }))
        .sort((a, b) => b.count - a.count);
    });

    // Duty hours summary by chaplain
    const dutyHoursSummary = computed(() => {
      const data = filteredDutyLogs.value;
      const byUser = {};
      data.forEach(log => {
        if (!byUser[log.userId]) {
          byUser[log.userId] = { userId: log.userId, totalHours: 0, shifts: 0, terminalCounts: {} };
        }
        const entry = byUser[log.userId];
        entry.totalHours += log.totalHours || 0;
        entry.shifts++;
        const terminal = getTerminalFromUser(log.userId);
        if (terminal !== '---') {
          entry.terminalCounts[terminal] = (entry.terminalCounts[terminal] || 0) + 1;
        }
      });

      // Compute weeks in range
      const startDate = getStartDate();
      const now = new Date();
      const weeks = Math.max(1, Math.ceil((now - startDate) / (7 * 24 * 60 * 60 * 1000)));

      return Object.values(byUser)
        .map(entry => ({
          userId: entry.userId,
          name: getUserName(entry.userId),
          totalHours: entry.totalHours,
          avgPerWeek: entry.totalHours / weeks,
          topTerminal: Object.entries(entry.terminalCounts).sort((a, b) => b[1] - a[1])[0]?.[0] || null
        }))
        .sort((a, b) => b.totalHours - a.totalHours);
    });

    const dutyGrandTotal = computed(() => {
      return dutyHoursSummary.value.reduce((sum, r) => sum + r.totalHours, 0);
    });

    // Stipend summary grouped by month
    const stipendSummary = computed(() => {
      const data = filteredStipends.value;
      const byMonth = {};
      data.forEach(s => {
        const key = s.monthName + '-' + s.year;
        if (!byMonth[key]) {
          byMonth[key] = { month: s.monthName, year: s.year, chaplains: new Set(), totalInstances: 0, totalAmount: 0 };
        }
        byMonth[key].chaplains.add(s.chaplainId);
        byMonth[key].totalInstances += s.instancesPaid || 0;
        byMonth[key].totalAmount += s.stipendAmount || 0;
      });
      return Object.values(byMonth).map(g => ({
        month: g.month,
        year: g.year,
        chaplainCount: g.chaplains.size,
        totalInstances: g.totalInstances,
        totalAmount: g.totalAmount,
        avgPerChaplain: g.chaplains.size > 0 ? g.totalAmount / g.chaplains.size : 0
      }));
    });

    const stipendYTD = computed(() => {
      const rows = stipendSummary.value;
      const chaplainSet = new Set();
      let instances = 0;
      let amount = 0;
      filteredStipends.value.forEach(s => {
        chaplainSet.add(s.chaplainId);
        instances += s.instancesPaid || 0;
        amount += s.stipendAmount || 0;
      });
      return {
        chaplains: chaplainSet.size,
        instances,
        amount,
        avg: chaplainSet.size > 0 ? amount / chaplainSet.size : 0
      };
    });

    // Helpers
    function getUserName(userId) {
      const user = users.value.find(u => u.id === userId);
      return user ? user.displayName : 'Unknown';
    }

    function getTerminalFromUser(userId) {
      const user = users.value.find(u => u.id === userId);
      return user?.terminals?.[0] || '---';
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function exportCSV(type) {
      showToast(type.charAt(0).toUpperCase() + type.slice(1) + ' CSV downloaded');
    }

    // Lifecycle
    onMounted(() => {
      window.addEventListener('resize', onResize);
      document.addEventListener('mockdb:ready', () => {
        users.value = mockDb.getAll('users');
        metrics.value = mockDb.getAll('chaplain_metrics');
        dutyLogs.value = mockDb.getAll('duty_logs');
        stipendRecords.value = mockDb.getAll('stipend_records');
        nextTick(() => lucide.createIcons());
      });
      lucide.createIcons();
    });

    onUnmounted(() => {
      window.removeEventListener('resize', onResize);
    });

    return {
      isMobile, currentDate,
      selectedRange, selectedTerminal, terminals, dateRanges,
      filteredMetrics, filteredDutyLogs, filteredStipends,
      encounterCounts, encounterTypeChart,
      dutyHoursSummary, dutyGrandTotal,
      stipendSummary, stipendYTD,
      toastVisible, toastMessage,
      getUserName, getTerminalFromUser, formatDate, exportCSV
    };
  }
}).mount('#app');
</script>

</body>
</html>
